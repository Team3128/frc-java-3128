<project name="frc-test">
    
     <!-- 
       _______   _____     _______
  	  |  _____| |  _  \   |  _____|
      | |____   | |_| |   | |
      | _____|  |  _  \   | |                       
      | |       | |  \ \  | |_____   |   _   _  |  
      |_|       |_|   \_| |_______| —|— |_| |_ —|— 
                                     |  |_   _| |  
           
       _                               
      | |      _         _           __      |
     —|—  |-,  _| ,-,-, |_| \  ^  / |  | |-, |/
      |   |   |_| | | | |_   \/ \/  |__| |   |\
      
    -->
  
  	<property name="jarpath" value="${build.dir}/"/>
	<property name="test-project" value="../frc-java-tests"/>  
	
	<property name="test-build.dir" value="build-test"/>
	
	<!-- assume that the test code is in the same workspce and cloned under the correct name  -->
	<property name="test-src.dir" value="${test-project}/src"/>  
	
	<property name="javassist-jar" value="lib/javassist.jar"/>
	<property name="guava-jar" value="lib/guava-18.0.jar"/>
	<property name="reflections-jar" value="lib/reflections-0.9.9-RC1.jar"/>
	<property name="frctest-jar" value="lib/FRC-Test.jar"/>
	<property name="junit.jar" value="${test-project}/lib/junit.jar"/>
	<property name="ant-junit.jar" value="${test-project}/lib/ant-junit.jar"/>
	<property name="hamcrest.jar" value="${test-project}/lib/hamcrest-core-1.3.jar"/>

	<property name="emulatorclasspath" value="${javassist-jar}:${guava-jar}:${reflections-jar}:${frctest-jar}"/>
	
	<!-- all of the jars needed to run test mode -->
	<property name="testclasspath" value="${emulatorclasspath}:${dist.jar}:${junit.jar}:${ant-junit.jar}:${hamcrest.jar}"/>
	
	
	<target name="test" depends="testcompile">
		<junit>
		  <batchtest>
		    <fileset dir="${test-build.dir}" includes="**/*.class"/>
		  </batchtest>
		  <classpath>
		    <pathelement path="${testclasspath}"/>
		    <pathelement location="${test-build.dir}"/>
		  </classpath>
		  <formatter type="plain" usefile="false" /> <!-- to screen -->
		  <!--formatter type="xml"/-->
		</junit>
		
		<mkdir dir="junit"/>
		
		<!-- junitreport todir="junit">
		 <fileset dir=".">
			 <include name="TEST-*.xml" />
		 </fileset>
		 <report todir="junit" />
	 </junitreport-->
	</target>
	
	<target name="runemulator" depends="emulatorjar" description="Run the robot emulator.">
		<java fork="true" classname="frctest.EmulatorMain">
		  <classpath>
		    <pathelement path="${emulatorclasspath}"/>
		    <pathelement location="${dist.jar}"/>
		  </classpath>
		</java>
	</target>
	
	<target name="emulatorjar" depends="emulatorcompile">
		<jar destfile="${dist.jar}" update="true">
		  <fileset dir="${build.dir}" includes="**/*.class"/>
		</jar>
	</target>
	
	<target name="testcompile" depends="emulatorjar" description="Compile the test code.">
		<mkdir dir="${test-build.dir}"/>
		<echo level="info">[FRC-Test] Compiling ${test-src.dir} to ${test-build.dir} using java ${ant.java.version}</echo>
		
		<javac srcdir="${test-src.dir}"
		 destdir="${test-build.dir}"
		 includeAntRuntime="no"
		 includeJavaRuntime="no"
		 classpath="${testclasspath}"
		 target="${ant.java.version}"
		 source="${ant.java.version}"
		 compiler="javac${ant.java.version}"
		 debug="true">
		</javac>
	</target>
	
	<target name="emulatorcompile" description="Compile the source code using the emulator jar.">
		<mkdir dir="${build.dir}"/>
		<echo level="info">[FRC-Test] Compiling ${src.dir} to ${build.dir} using java ${ant.java.version}</echo>
		<echo level="info">[FRC-Test] Classpath: ${emulatorclasspath}</echo>
		

		<!-- check javac version, since the Eclipse-included Ant seems to sometimes use an older one-->
		<if>
		  	<equals arg1="${ant.java.version}" arg2="1.8"/>
			<then>
	  		</then>
		  	<else>
				<echo>[FRC-Test] Ant is using an older java version (${ant.java.version}), if the compile fails that's probably why!</echo>
		  	</else>
		</if>
		
		<javac srcdir="${src.dir}"
		 destdir="${build.dir}"
		 includeAntRuntime="no"
		 includeJavaRuntime="no"
		 classpath="${emulatorclasspath}"
		 target="${ant.java.version}"
		 source="${ant.java.version}"
		 compiler="javac${ant.java.version}"
		 debug="true">
		</javac>
	</target>
</project>